services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: edutrackr-backend
    ports:
      - "${SERVER_PORT-5000}:5000"
    environment:
      - SERVER_PORT=${SERVER_PORT-5000}
      - SERVER_URL=${SERVER_URL-http://localhost}
      - DEBUG=${DEBUG-true}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_MODEL=${OPENAI_MODEL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_ACCESS_TOKEN=${SUPABASE_ACCESS_TOKEN}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./backend:/app
    command:
      [
        "sh",
        "-c",
        "python -m flask --app app.main:app run --host=0.0.0.0 --port=5000",
      ]

  frontend_dev:
    image: node:20-alpine
    container_name: edutrackr-frontend-dev
    working_dir: /app
    ports:
      - "5173:80"
    environment:
      - CLIENT_PORT=80
      - VITE_PROXY_TARGET=http://backend:5000
      - SERVER_URL=http://backend:5000
    volumes:
      - ./frontend:/app
    command: ["sh", "-c", "npm ci --no-audit --no-fund && npm run dev"]
    depends_on:
      - backend

  client_preview:
    image: node:20-alpine
    container_name: edutrackr-client-preview
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    command: ["sh", "-c", "npm run preview"]
    depends_on:
      - backend
networks:
  default:
    name: edutrackr
