services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: edutrackr-backend
    ports:
      - "${SERVER_PORT-5000}:5000"
    env_file:
      - .env
    environment:
      - SERVER_PORT=${SERVER_PORT-5000}
      - SERVER_URL=${SERVER_URL-http://localhost}
      - DEBUG=${DEBUG-true}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_MODEL=${OPENAI_MODEL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_ACCESS_TOKEN=${SUPABASE_ACCESS_TOKEN}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./backend:/app
    command:
      [
        "sh",
        "-c",
        "python -m flask --app app.main:app run --host=0.0.0.0 --port=5000",
      ]

  db:
    image: postgres:16-alpine
    container_name: edutrackr-db
    ports:
      - "54322:5432"
    environment:
      - POSTGRES_USER=edutrackr
      - POSTGRES_PASSWORD=edutrackr
      - POSTGRES_DB=edutrackr
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U edutrackr -d edutrackr"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend_dev:
    image: node:20-alpine
    container_name: edutrackr-frontend-dev
    working_dir: /app
    ports:
      - "${CLIENT_PORT-5173}:5173"
    environment:
      - CLIENT_PORT=${CLIENT_PORT-5173}
      - SERVER_URL=${SERVER_URL-http://localhost}
    volumes:
      - ./frontend:/app
    command: ["sh", "-c", "npm ci --no-audit --no-fund && npm run dev"]
    depends_on:
      - backend
      - db

  client_preview:
    image: node:20-alpine
    container_name: edutrackr-client-preview
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    command: ["sh", "-c", "npm run preview"]
    depends_on:
      - backend
networks:
  default:
    name: edutrackr
volumes:
  db-data:
